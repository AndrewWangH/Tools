<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>房贷计算器</title>
    <style>
        :root {
            --primary-color: #0066cc;
            --secondary-color: #cc6600;
            --background-color: #f5f5f5;
            --border-color: #dddddd;
            --text-color: #333333;
            --light-text: #666666;
            --success-color: #28a745;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .container {
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .input-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }
        
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            background-color: white;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            width: 100%;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #0055aa;
        }
        
        .summary {
            background-color: white;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 4px 4px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .summary h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        
        .tab.active {
            background-color: white;
            border-color: var(--border-color);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .comparison {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .comparison-item {
            flex: 1;
            min-width: 300px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 10px;
            text-align: right;
            border: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--background-color);
            text-align: center;
            font-weight: bold;
        }
        
        .ellipsis {
            text-align: center;
            padding: 10px;
        }
        
        .csv-link {
            display: inline-block;
            margin: 10px 0;
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .csv-link:hover {
            text-decoration: underline;
        }
        
        .prepayment-section {
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }
        
        .highlight {
            color: var(--secondary-color);
            font-weight: bold;
        }
        
        .chart-container {
            width: 100%;
            height: 400px;
            margin: 20px 0;
            background-color: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .special-note {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            margin: 20px 0;
            border-radius: 0 4px 4px 0;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .comparison {
                flex-direction: column;
            }
            
            .comparison-item {
                min-width: 100%;
            }
            
            .chart-container {
                height: 300px;
            }
            
            table {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <h1>房贷计算器</h1>
    
    <div class="container">
        <div class="input-section">
            <div class="form-group">
                <label for="loanAmount">贷款总额 (元)</label>
                <input type="number" id="loanAmount" min="10000" step="10000" value="1300000">
            </div>
            
            <div class="form-group">
                <label for="interestRate">年利率 (%)</label>
                <input type="number" id="interestRate" min="0.1" max="20" step="0.01" value="2.6">
            </div>
            
            <div class="form-group">
                <label for="loanTerm">贷款期限 (年)</label>
                <input type="number" id="loanTerm" min="1" max="30" step="1" value="20">
            </div>
        </div>
        
        <button id="calculateBtn">计算结果</button>
    </div>
    
    <div id="resultsContainer" style="display:none;">
        <div class="tabs">
            <div class="tab active" data-tab="comparison">还款方式对比</div>
            <div class="tab" data-tab="installment">等额本息详情</div>
            <div class="tab" data-tab="principal">等额本金详情</div>
            <div class="tab" data-tab="prepayment">提前还款分析</div>
        </div>
        
        <div class="tab-content active" id="comparison">
            <div class="container">
                <h2>房贷计算结果</h2>
                <div id="loanInfo" class="special-note"></div>
                
                <div class="chart-container">
                    <canvas id="paymentChart"></canvas>
                </div>
                
                <div class="comparison">
                    <div class="comparison-item">
                        <div class="summary">
                            <h3>等额本息还款方式</h3>
                            <p><strong>月付款额：</strong> <span id="monthlyPayment"></span> 元</p>
                            <p><strong>总还款额：</strong> <span id="totalPayment"></span> 元</p>
                            <p><strong>支付利息：</strong> <span id="totalInterest"></span> 元</p>
                        </div>
                    </div>
                    
                    <div class="comparison-item">
                        <div class="summary">
                            <h3>等额本金还款方式</h3>
                            <p><strong>首月还款：</strong> <span id="firstPayment"></span> 元</p>
                            <p><strong>月均还款：</strong> <span id="averagePayment"></span> 元</p>
                            <p><strong>末月还款：</strong> <span id="lastPayment"></span> 元</p>
                            <p><strong>总还款额：</strong> <span id="principalTotalPayment"></span> 元</p>
                            <p><strong>支付利息：</strong> <span id="principalTotalInterest"></span> 元</p>
                        </div>
                    </div>
                </div>
                
                <div class="special-note">
                    <p><strong>对比结论：</strong> <span id="comparisonResult"></span></p>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="installment">
            <div class="container">
                <h2>等额本息还款计划</h2>
                <p>每月还款额固定为 <span class="highlight" id="fixedMonthlyPayment"></span> 元</p>
                <p><a href="#" id="downloadInstallmentCSV" class="csv-link">下载完整还款计划(CSV)</a></p>
                
                <table>
                    <thead>
                        <tr>
                            <th>月份</th>
                            <th>月供(元)</th>
                            <th>本金(元)</th>
                            <th>利息(元)</th>
                            <th>剩余本金(元)</th>
                        </tr>
                    </thead>
                    <tbody id="installmentTableBody">
                        <!-- 表格内容由JavaScript生成 -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="principal">
            <div class="container">
                <h2>等额本金还款计划</h2>
                <p>每月本金固定为 <span class="highlight" id="fixedMonthlyPrincipal"></span> 元</p>
                <p><a href="#" id="downloadPrincipalCSV" class="csv-link">下载完整还款计划(CSV)</a></p>
                
                <table>
                    <thead>
                        <tr>
                            <th>月份</th>
                            <th>月供(元)</th>
                            <th>本金(元)</th>
                            <th>利息(元)</th>
                            <th>剩余本金(元)</th>
                        </tr>
                    </thead>
                    <tbody id="principalTableBody">
                        <!-- 表格内容由JavaScript生成 -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="prepayment">
            <div class="container">
                <h2>提前还款分析</h2>
                
                <div class="input-section">
                    <div class="form-group">
                        <label for="prepaymentAmount">提前还款金额 (元)</label>
                        <input type="number" id="prepaymentAmount" min="10000" step="10000" value="300000">
                    </div>
                    
                    <div class="form-group">
                        <label for="prepaymentMonth">提前还款时间 (第几个月)</label>
                        <input type="number" id="prepaymentMonth" min="1" value="60">
                    </div>
                    
                    <div class="form-group">
                        <label for="prepaymentMethod">提前还款方式</label>
                        <select id="prepaymentMethod">
                            <option value="reduce_term">缩短贷款期限</option>
                            <option value="reduce_payment">减少月供</option>
                        </select>
                    </div>
                </div>
                
                <button id="calculatePrepayment">计算提前还款</button>
                
                <div id="prepaymentResults" style="display:none;">
                    <div class="summary">
                        <h3>提前还款分析结果</h3>
                        <p><strong>提前还款金额：</strong> <span id="prepayAmount"></span> 元</p>
                        <p><strong>提前还款时间：</strong> 第 <span id="prepayMonth"></span> 个月</p>
                        <p><strong>原始贷款信息：</strong> <span id="originalLoanInfo"></span></p>
                        <p><strong>预计节省利息：</strong> <span id="savedInterest" class="highlight"></span> 元</p>
                        <p id="newTermContainer"><strong>新贷款期限：</strong> <span id="newTerm"></span> 个月</p>
                        <p id="newPaymentContainer"><strong>新月供金额：</strong> <span id="newPayment"></span> 元</p>
                        <p><strong>提前还款后总支出：</strong> <span id="totalCostAfterPrepay"></span> 元</p>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="prepaymentChart"></canvas>
                    </div>
                    
                    <h3>提前还款前后对比</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>项目</th>
                                <th>原计划</th>
                                <th>提前还款后</th>
                                <th>差额</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>总利息</td>
                                <td id="originalInterest"></td>
                                <td id="newInterest"></td>
                                <td id="interestDifference" class="highlight"></td>
                            </tr>
                            <tr>
                                <td>总支出</td>
                                <td id="originalTotalCost"></td>
                                <td id="newTotalCost"></td>
                                <td id="totalCostDifference"></td>
                            </tr>
                            <tr id="termRow">
                                <td>贷款期限</td>
                                <td id="originalTerm"></td>
                                <td id="prepaymentNewTerm"></td>
                                <td id="termDifference" class="highlight"></td>
                            </tr>
                            <tr id="paymentRow">
                                <td>月供</td>
                                <td id="originalPayment"></td>
                                <td id="prepaymentNewPayment"></td>
                                <td id="paymentDifference" class="highlight"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // 全局变量
        let loanAmount, annualRate, loanTerm;
        let installmentDetails = [];
        let principalDetails = [];
        let paymentChart = null;
        let prepaymentChart = null;
        
        // DOM加载完成后初始化事件监听
        document.addEventListener('DOMContentLoaded', function() {
            // 计算按钮事件
            document.getElementById('calculateBtn').addEventListener('click', calculateResults);
            
            // 标签切换事件
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
            
            // 提前还款计算按钮事件
            document.getElementById('calculatePrepayment').addEventListener('click', calculatePrepayment);
            
            // CSV下载事件
            document.getElementById('downloadInstallmentCSV').addEventListener('click', function(e) {
                e.preventDefault();
                downloadCSV(installmentDetails, '等额本息还款计划');
            });
            
            document.getElementById('downloadPrincipalCSV').addEventListener('click', function(e) {
                e.preventDefault();
                downloadCSV(principalDetails, '等额本金还款计划');
            });
        });
        
        // 计算结果
        function calculateResults() {
            // 获取输入值
            loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const interestRatePercent = parseFloat(document.getElementById('interestRate').value);
            annualRate = interestRatePercent / 100; // 转换为小数
            loanTerm = parseInt(document.getElementById('loanTerm').value);
            
            // 检查输入
            if (isNaN(loanAmount) || isNaN(annualRate) || isNaN(loanTerm) || 
                loanAmount <= 0 || annualRate <= 0 || loanTerm <= 0) {
                alert('请输入有效的贷款信息');
                return;
            }
            
            // 显示结果区域
            document.getElementById('resultsContainer').style.display = 'block';
            
            // 显示贷款基本信息
            document.getElementById('loanInfo').textContent = 
                `贷款金额: ${formatCurrency(loanAmount)}元, 年利率: ${interestRatePercent.toFixed(2)}%, 贷款期限: ${loanTerm}年`;
            
            // 计算等额本息
            calculateEqualInstallment();
            
            // 计算等额本金
            calculateEqualPrincipal();
            
            // 比较两种方式
            comparePaymentMethods();
            
            // 绘制图表
            drawPaymentChart();
            
            // 默认显示第一个标签
            document.querySelectorAll('.tab')[0].click();
            
            // 滚动到结果区域
            document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 计算等额本息
        function calculateEqualInstallment() {
            const monthlyRate = annualRate / 12;
            const totalMonths = loanTerm * 12;
            
            // 等额本息月供计算公式
            let monthlyPayment;
            if (monthlyRate === 0) {
                monthlyPayment = loanAmount / totalMonths;
            } else {
                monthlyPayment = loanAmount * monthlyRate * Math.pow(1 + monthlyRate, totalMonths) / 
                                 (Math.pow(1 + monthlyRate, totalMonths) - 1);
            }
            
            const totalPayment = monthlyPayment * totalMonths;
            const totalInterest = totalPayment - loanAmount;
            
            // 显示基本结果
            document.getElementById('monthlyPayment').textContent = formatCurrency(monthlyPayment);
            document.getElementById('totalPayment').textContent = formatCurrency(totalPayment);
            document.getElementById('totalInterest').textContent = formatCurrency(totalInterest);
            document.getElementById('fixedMonthlyPayment').textContent = formatCurrency(monthlyPayment);
            
            // 计算每月详情
            installmentDetails = [];
            let remainingBalance = loanAmount;
            
            for (let month = 1; month <= totalMonths; month++) {
                const interestPayment = remainingBalance * monthlyRate;
                let principalPayment = monthlyPayment - interestPayment;
                
                // 处理最后一个月的舍入误差
                if (month === totalMonths) {
                    if (Math.abs(remainingBalance - principalPayment) < 0.01) {
                        principalPayment = remainingBalance;
                    }
                }
                
                remainingBalance -= principalPayment;
                
                // 处理可能的负值
                if (remainingBalance < 0) {
                    remainingBalance = 0;
                }
                
                installmentDetails.push({
                    month: month,
                    payment: monthlyPayment,
                    principal: principalPayment,
                    interest: interestPayment,
                    balance: remainingBalance
                });
            }
            
            // 填充还款表格
            populatePaymentTable('installmentTableBody', installmentDetails);
        }
        
        // 计算等额本金
        function calculateEqualPrincipal() {
            const monthlyRate = annualRate / 12;
            const totalMonths = loanTerm * 12;
            const monthlyPrincipal = loanAmount / totalMonths;
            
            // 显示固定月本金
            document.getElementById('fixedMonthlyPrincipal').textContent = formatCurrency(monthlyPrincipal);
            
            // 计算每月详情
            principalDetails = [];
            let remainingBalance = loanAmount;
            let totalPayment = 0;
            
            for (let month = 1; month <= totalMonths; month++) {
                const interestPayment = remainingBalance * monthlyRate;
                const monthlyPayment = monthlyPrincipal + interestPayment;
                
                remainingBalance -= monthlyPrincipal;
                
                // 处理可能的负值
                if (remainingBalance < 0) {
                    remainingBalance = 0;
                }
                
                totalPayment += monthlyPayment;
                
                principalDetails.push({
                    month: month,
                    payment: monthlyPayment,
                    principal: monthlyPrincipal,
                    interest: interestPayment,
                    balance: remainingBalance
                });
            }
            
            const totalInterest = totalPayment - loanAmount;
            const firstPayment = principalDetails[0].payment;
            const lastPayment = principalDetails[principalDetails.length - 1].payment;
            const averagePayment = totalPayment / totalMonths;
            
            // 显示基本结果
            document.getElementById('firstPayment').textContent = formatCurrency(firstPayment);
            document.getElementById('lastPayment').textContent = formatCurrency(lastPayment);
            document.getElementById('averagePayment').textContent = formatCurrency(averagePayment);
            document.getElementById('principalTotalPayment').textContent = formatCurrency(totalPayment);
            document.getElementById('principalTotalInterest').textContent = formatCurrency(totalInterest);
            
            // 填充还款表格
            populatePaymentTable('principalTableBody', principalDetails);
        }
        
        // 比较两种还款方式
        function comparePaymentMethods() {
            const installmentTotalInterest = parseFloat(document.getElementById('totalInterest').textContent.replace(/,/g, ''));
            const principalTotalInterest = parseFloat(document.getElementById('principalTotalInterest').textContent.replace(/,/g, ''));
            const installmentMonthly = parseFloat(document.getElementById('monthlyPayment').textContent.replace(/,/g, ''));
            const principalFirstMonthly = parseFloat(document.getElementById('firstPayment').textContent.replace(/,/g, ''));
            const principalLastMonthly = parseFloat(document.getElementById('lastPayment').textContent.replace(/,/g, ''));
            
            let conclusion = '';
            
            if (principalTotalInterest < installmentTotalInterest) {
                const savedInterest = installmentTotalInterest - principalTotalInterest;
                conclusion += `等额本金方式比等额本息方式可节省利息 ${formatCurrency(savedInterest)} 元（${(savedInterest / installmentTotalInterest * 100).toFixed(2)}%）。`;
            } else {
                conclusion += '等额本息方式总利息支出更少。';
            }
            
            conclusion += ` 等额本金首月还款 ${formatCurrency(principalFirstMonthly)} 元，比等额本息月供 ${formatCurrency(installmentMonthly)} 元`;
            if (principalFirstMonthly > installmentMonthly) {
                conclusion += `多 ${formatCurrency(principalFirstMonthly - installmentMonthly)} 元（${((principalFirstMonthly / installmentMonthly - 1) * 100).toFixed(2)}%）`;
            } else {
                conclusion += `少 ${formatCurrency(installmentMonthly - principalFirstMonthly)} 元（${((1 - principalFirstMonthly / installmentMonthly) * 100).toFixed(2)}%）`;
            }
            
            conclusion += `，但随着时间推移月供会逐渐减少，最后一个月仅需还款 ${formatCurrency(principalLastMonthly)} 元。`;
            
            document.getElementById('comparisonResult').innerHTML = conclusion;
        }
        
        // 填充还款表格
        function populatePaymentTable(tableId, details) {
            const tableBody = document.getElementById(tableId);
            tableBody.innerHTML = '';
            
            // 显示前5个月
            // for (let i = 0; i < Math.min(5, details.length); i++) {
            //     tableBody.appendChild(createTableRow(details[i]));
            // }
            
            // // 如果月份超过10个，添加省略号
            // if (details.length > 10) {
            //     const ellipsisRow = document.createElement('tr');
            //     ellipsisRow.classList.add('ellipsis');
            //     ellipsisRow.innerHTML = '<td colspan="5">...</td>';
            //     tableBody.appendChild(ellipsisRow);
            // }
            
            // // 显示最后5个月
            // for (let i = Math.max(5, details.length - 5); i < details.length; i++) {
            //     tableBody.appendChild(createTableRow(details[i]));
            // }


            for (let i = 0; i < details.length; i++) {
                tableBody.appendChild(createTableRow(details[i]));
            }
        }
        
        // 创建表格行
        function createTableRow(data) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${data.month}</td>
                <td>${formatCurrency(data.payment)}</td>
                <td>${formatCurrency(data.principal)}</td>
                <td>${formatCurrency(data.interest)}</td>
                <td>${formatCurrency(data.balance)}</td>
            `;
            return row;
        }
        
        // 绘制还款对比图表
        function drawPaymentChart() {
            // 清除旧图表
            if (paymentChart) {
                paymentChart.destroy();
            }
            
            const ctx = document.getElementById('paymentChart').getContext('2d');
            
            // 准备数据
            const labels = [];
            const installmentData = [];
            const principalData = [];
            
            // 每12个月取一个点（每年）
            for (let i = 0; i < loanTerm * 12; i += 12) {
                const yearLabel = `第${Math.floor(i/12) + 1}年`;
                labels.push(yearLabel);
                
                // 等额本息数据
                if (i < installmentDetails.length) {
                    installmentData.push(installmentDetails[i].payment);
                }
                
                // 等额本金数据
                if (i < principalDetails.length) {
                    principalData.push(principalDetails[i].payment);
                }
            }
            
            // 添加最后一个月
            if (principalDetails.length > 0) {
                labels.push(`最后一月`);
                installmentData.push(installmentDetails[installmentDetails.length - 1].payment);
                principalData.push(principalDetails[principalDetails.length - 1].payment);
            }
            
            paymentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '等额本息月供',
                            data: installmentData,
                            borderColor: '#0066cc',
                            backgroundColor: 'rgba(0, 102, 204, 0.1)',
                            tension: 0.1,
                            fill: true
                        },
                        {
                            label: '等额本金月供',
                            data: principalData,
                            borderColor: '#cc6600',
                            backgroundColor: 'rgba(204, 102, 0, 0.1)',
                            tension: 0.1,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '两种还款方式月供对比'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw) + ' 元';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '月供金额 (元)'
                            },
                            beginAtZero: true
                        },
                        x: {
                            title: {
                                display: true,
                                text: '还款期'
                            }
                        }
                    }
                }
            });
        }
        
        // 计算提前还款
        function calculatePrepayment() {
            if (installmentDetails.length === 0) {
                alert('请先计算基本房贷信息');
                return;
            }
            
            // 获取提前还款参数
            const prepaymentAmount = parseFloat(document.getElementById('prepaymentAmount').value);
            const prepaymentMonth = parseInt(document.getElementById('prepaymentMonth').value);
            const prepaymentMethod = document.getElementById('prepaymentMethod').value;
            
            // 检查参数
            if (isNaN(prepaymentAmount) || isNaN(prepaymentMonth) || prepaymentAmount <= 0 || prepaymentMonth < 1) {
                alert('请输入有效的提前还款信息');
                return;
            }
            
            // 检查还款月份是否超出贷款期限
            if (prepaymentMonth > installmentDetails.length) {
                alert(`提前还款月份超出贷款期限 (${installmentDetails.length}个月)`);
                return;
            }
            
            // 获取提前还款时的剩余本金
            const remainingBalance = installmentDetails[prepaymentMonth - 1].balance;
            
            if (prepaymentAmount >= remainingBalance) {
                // 一次性还清
                showFullRepaymentResults(prepaymentAmount, prepaymentMonth, remainingBalance);
                return;
            }
            
            const monthlyRate = annualRate / 12;
            const newPrincipal = remainingBalance - prepaymentAmount;
            
            if (prepaymentMethod === 'reduce_term') {
                // 缩短贷款期限
                let newTerm;
                const monthlyPayment = installmentDetails[0].payment; // 原月供
                
                if (monthlyRate === 0) {
                    newTerm = Math.ceil(newPrincipal / monthlyPayment);
                } else {
                    // 计算新的期限
                    const numerator = monthlyPayment - newPrincipal * monthlyRate;
                    const denominator = monthlyPayment * monthlyRate;
                    
                    if (numerator <= 0) {
                        newTerm = Infinity;
                    } else {
                        newTerm = Math.ceil(-Math.log(1 - denominator / numerator) / Math.log(1 + monthlyRate));
                    }
                }
                
                // 计算新的还款计划
                const newSchedule = calculateNewSchedule(newPrincipal, monthlyRate, newTerm, monthlyPayment);
                const newTotalPayment = monthlyPayment * newTerm;
                const newTotalInterest = newTotalPayment - newPrincipal;
                
                // 计算节省的利息
                const originalRemainingInterest = installmentDetails
                    .slice(prepaymentMonth)
                    .reduce((sum, item) => sum + item.interest, 0);
                
                const savedInterest = originalRemainingInterest - newTotalInterest;
                
                // 显示结果
                document.getElementById('prepaymentResults').style.display = 'block';
                document.getElementById('prepayAmount').textContent = formatCurrency(prepaymentAmount);
                document.getElementById('prepayMonth').textContent = prepaymentMonth;
                document.getElementById('originalLoanInfo').textContent = 
                    `贷款金额 ${formatCurrency(loanAmount)}元, 期限 ${loanTerm}年, 年利率 ${(annualRate*100).toFixed(2)}%`;
                document.getElementById('savedInterest').textContent = formatCurrency(savedInterest);
                document.getElementById('newTerm').textContent = newTerm;
                document.getElementById('newTermContainer').style.display = 'block';
                document.getElementById('newPaymentContainer').style.display = 'none';
                document.getElementById('totalCostAfterPrepay').textContent = 
                    formatCurrency(loanAmount + prepaymentAmount + installmentDetails
                        .slice(0, prepaymentMonth-1)
                        .reduce((sum, item) => sum + item.interest, 0) + newTotalInterest);
                
                // 比较表格
                document.getElementById('originalInterest').textContent = formatCurrency(
                    installmentDetails.reduce((sum, item) => sum + item.interest, 0));
                document.getElementById('newInterest').textContent = formatCurrency(
                    installmentDetails.slice(0, prepaymentMonth-1).reduce((sum, item) => sum + item.interest, 0) + newTotalInterest);
                document.getElementById('interestDifference').textContent = formatCurrency(savedInterest);
                
                document.getElementById('originalTotalCost').textContent = formatCurrency(loanAmount + 
                    installmentDetails.reduce((sum, item) => sum + item.interest, 0));
                document.getElementById('newTotalCost').textContent = formatCurrency(loanAmount + 
                    installmentDetails.slice(0, prepaymentMonth-1).reduce((sum, item) => sum + item.interest, 0) + newTotalInterest);
                document.getElementById('totalCostDifference').textContent = formatCurrency(savedInterest);
                
                document.getElementById('originalTerm').textContent = `${loanTerm * 12}个月`;
                document.getElementById('prepaymentNewTerm').textContent = `${newTerm}个月`;
                document.getElementById('termDifference').textContent = `减少 ${loanTerm * 12 - newTerm}个月`;
                
                document.getElementById('termRow').style.display = '';
                document.getElementById('paymentRow').style.display = 'none';
                
                // 绘制提前还款图表
                drawPrepaymentChart(prepaymentMonth, newTerm, newSchedule);
                
            } else if (prepaymentMethod === 'reduce_payment') {
                // 减少月供
                const remainingOriginalTerm = installmentDetails.length - prepaymentMonth + 1;
                
                let newMonthlyPayment;
                if (monthlyRate === 0) {
                    newMonthlyPayment = newPrincipal / remainingOriginalTerm;
                } else {
                    newMonthlyPayment = newPrincipal * monthlyRate * Math.pow(1 + monthlyRate, remainingOriginalTerm) / 
                                     (Math.pow(1 + monthlyRate, remainingOriginalTerm) - 1);
                }
                
                // 计算新的还款计划
                const newSchedule = calculateNewSchedule(newPrincipal, monthlyRate, remainingOriginalTerm, newMonthlyPayment);
                const newTotalPayment = newMonthlyPayment * remainingOriginalTerm;
                const newTotalInterest = newTotalPayment - newPrincipal;
                
                // 计算节省的利息
                const originalRemainingInterest = installmentDetails
                    .slice(prepaymentMonth)
                    .reduce((sum, item) => sum + item.interest, 0);
                
                const savedInterest = originalRemainingInterest - newTotalInterest;
                const originalMonthlyPayment = installmentDetails[0].payment;
                
                // 显示结果
                document.getElementById('prepaymentResults').style.display = 'block';
                document.getElementById('prepayAmount').textContent = formatCurrency(prepaymentAmount);
                document.getElementById('prepayMonth').textContent = prepaymentMonth;
                document.getElementById('originalLoanInfo').textContent = 
                    `贷款金额 ${formatCurrency(loanAmount)}元, 期限 ${loanTerm}年, 年利率 ${(annualRate*100).toFixed(2)}%`;
                document.getElementById('savedInterest').textContent = formatCurrency(savedInterest);
                document.getElementById('newPayment').textContent = formatCurrency(newMonthlyPayment);
                document.getElementById('newTermContainer').style.display = 'none';
                document.getElementById('newPaymentContainer').style.display = 'block';
                document.getElementById('totalCostAfterPrepay').textContent = 
                    formatCurrency(loanAmount + prepaymentAmount + installmentDetails
                        .slice(0, prepaymentMonth-1)
                        .reduce((sum, item) => sum + item.interest, 0) + newTotalInterest);
                
                // 比较表格
                document.getElementById('originalInterest').textContent = formatCurrency(
                    installmentDetails.reduce((sum, item) => sum + item.interest, 0));
                document.getElementById('newInterest').textContent = formatCurrency(
                    installmentDetails.slice(0, prepaymentMonth-1).reduce((sum, item) => sum + item.interest, 0) + newTotalInterest);
                document.getElementById('interestDifference').textContent = formatCurrency(savedInterest);
                
                document.getElementById('originalTotalCost').textContent = formatCurrency(loanAmount + 
                    installmentDetails.reduce((sum, item) => sum + item.interest, 0));
                document.getElementById('newTotalCost').textContent = formatCurrency(loanAmount + 
                    installmentDetails.slice(0, prepaymentMonth-1).reduce((sum, item) => sum + item.interest, 0) + newTotalInterest);
                document.getElementById('totalCostDifference').textContent = formatCurrency(savedInterest);
                
                document.getElementById('originalPayment').textContent = `${formatCurrency(originalMonthlyPayment)}元`;
                document.getElementById('prepaymentNewPayment').textContent = `${formatCurrency(newMonthlyPayment)}元`;
                document.getElementById('paymentDifference').textContent = 
                    `减少 ${formatCurrency(originalMonthlyPayment - newMonthlyPayment)}元`;
                
                document.getElementById('termRow').style.display = 'none';
                document.getElementById('paymentRow').style.display = '';
                
                // 绘制提前还款图表
                drawPrepaymentChart(prepaymentMonth, remainingOriginalTerm, newSchedule);
            }
        }
        
        // 显示一次性还清的结果
        function showFullRepaymentResults(prepaymentAmount, prepaymentMonth, remainingBalance) {
            const originalRemainingInterest = installmentDetails
                .slice(prepaymentMonth)
                .reduce((sum, item) => sum + item.interest, 0);
            
            document.getElementById('prepaymentResults').style.display = 'block';
            document.getElementById('prepayAmount').textContent = formatCurrency(prepaymentAmount);
            document.getElementById('prepayMonth').textContent = prepaymentMonth;
            document.getElementById('originalLoanInfo').textContent = 
                `贷款金额 ${formatCurrency(loanAmount)}元, 期限 ${loanTerm}年, 年利率 ${(annualRate*100).toFixed(2)}%`;
            document.getElementById('savedInterest').textContent = formatCurrency(originalRemainingInterest);
            document.getElementById('newTerm').textContent = '0 (已结清)';
            document.getElementById('newTermContainer').style.display = 'block';
            document.getElementById('newPaymentContainer').style.display = 'none';
            document.getElementById('totalCostAfterPrepay').textContent = 
                formatCurrency(loanAmount + installmentDetails
                    .slice(0, prepaymentMonth-1)
                    .reduce((sum, item) => sum + item.interest, 0));
            
            // 比较表格
            document.getElementById('originalInterest').textContent = formatCurrency(
                installmentDetails.reduce((sum, item) => sum + item.interest, 0));
            document.getElementById('newInterest').textContent = formatCurrency(
                installmentDetails.slice(0, prepaymentMonth-1).reduce((sum, item) => sum + item.interest, 0));
            document.getElementById('interestDifference').textContent = formatCurrency(originalRemainingInterest);
            
            document.getElementById('originalTotalCost').textContent = formatCurrency(loanAmount + 
                installmentDetails.reduce((sum, item) => sum + item.interest, 0));
            document.getElementById('newTotalCost').textContent = formatCurrency(loanAmount + 
                installmentDetails.slice(0, prepaymentMonth-1).reduce((sum, item) => sum + item.interest, 0));
            document.getElementById('totalCostDifference').textContent = formatCurrency(originalRemainingInterest);
            
            document.getElementById('originalTerm').textContent = `${loanTerm * 12}个月`;
            document.getElementById('prepaymentNewTerm').textContent = `${prepaymentMonth}个月(已结清)`;
            document.getElementById('termDifference').textContent = `减少 ${loanTerm * 12 - prepaymentMonth}个月`;
            
            document.getElementById('termRow').style.display = '';
            document.getElementById('paymentRow').style.display = 'none';
            
            // 绘制提前还款图表 - 无新还款计划，所以传递空数组
            drawPrepaymentChart(prepaymentMonth, 0, []);
        }
        
        // 计算新的还款计划
        function calculateNewSchedule(principal, monthlyRate, term, monthlyPayment) {
            const schedule = [];
            let remainingBalance = principal;
            
            for (let month = 1; month <= term; month++) {
                const interestPayment = remainingBalance * monthlyRate;
                let principalPayment = monthlyPayment - interestPayment;
                
                // 处理最后一个月的舍入误差
                if (month === term) {
                    if (Math.abs(remainingBalance - principalPayment) < 0.01) {
                        principalPayment = remainingBalance;
                    }
                }
                
                remainingBalance -= principalPayment;
                
                // 处理可能的负值
                if (remainingBalance < 0) {
                    remainingBalance = 0;
                }
                
                schedule.push({
                    month: month,
                    payment: monthlyPayment,
                    principal: principalPayment,
                    interest: interestPayment,
                    balance: remainingBalance
                });
            }
            
            return schedule;
        }
        
        // 绘制提前还款对比图表
        function drawPrepaymentChart(prepaymentMonth, newTerm, newSchedule) {
            // 清除旧图表
            if (prepaymentChart) {
                prepaymentChart.destroy();
            }
            
            const ctx = document.getElementById('prepaymentChart').getContext('2d');
            
            // 准备数据
            const labels = [];
            const originalData = [];
            const newData = [];
            
            // 添加原始还款计划数据 - 按季度汇总
            for (let i = 0; i < installmentDetails.length; i += 3) {
                if (i % 12 === 0) { // 每年标记一次
                    labels.push(`第${Math.floor(i/12) + 1}年`);
                } else {
                    labels.push('');
                }
                originalData.push(installmentDetails[i].payment);
                
                // 提前还款前的数据相同
                if (i < prepaymentMonth) {
                    newData.push(installmentDetails[i].payment);
                } 
                // 提前还款后，如果有新计划，使用新计划；否则为0（已还清）
                else if (i - prepaymentMonth < newSchedule.length) {
                    newData.push(newSchedule[i - prepaymentMonth].payment);
                } else {
                    newData.push(0);
                }
            }
            
            prepaymentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '原始还款计划',
                            data: originalData,
                            borderColor: '#999999',
                            backgroundColor: 'rgba(153, 153, 153, 0.1)',
                            pointRadius: 2,
                            tension: 0.1
                        },
                        {
                            label: '提前还款后',
                            data: newData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            pointRadius: 2,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '提前还款前后月供对比'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw) + ' 元';
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    xMin: prepaymentMonth / 3,
                                    xMax: prepaymentMonth / 3,
                                    borderColor: 'red',
                                    borderWidth: 2,
                                    label: {
                                        content: '提前还款时点',
                                        enabled: true
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '月供金额 (元)'
                            },
                            beginAtZero: true
                        },
                        x: {
                            title: {
                                display: true,
                                text: '还款期'
                            }
                        }
                    }
                }
            });
        }
        
        // 格式化货币
        function formatCurrency(value) {
            return new Intl.NumberFormat('zh-CN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }
        
        // 下载CSV文件
        function downloadCSV(details, filename) {
            // 生成CSV内容
            let csvContent = "月份,月供(元),本金(元),利息(元),剩余本金(元)\n";
            
            details.forEach(row => {
                csvContent += `${row.month},${row.payment.toFixed(2)},${row.principal.toFixed(2)},${row.interest.toFixed(2)},${row.balance.toFixed(2)}\n`;
            });
            
            // 创建下载链接
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${filename}_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            
            // 触发下载
            link.click();
            
            // 移除链接
            document.body.removeChild(link);
        }
    </script>
</body>
</html>